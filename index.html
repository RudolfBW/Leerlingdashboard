<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leerlingoverzicht</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-0: #0b0f14;
      --bg-1: #0e141b;
      --bg-2: #111a24;
      --panel: rgba(16, 23, 31, 0.9);
      --panel-strong: #0f151c;
      --border: #263142;
      --border-soft: rgba(62, 76, 92, 0.4);
      --text: #e6edf4;
      --muted: #a2b1bf;
      --muted-2: #7f8d9a;
      --accent: #3ba97c;
      --green: #3bd37a;
      --orange: #f2a33a;
      --red: #f45a5a;
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--text);
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background: radial-gradient(1200px 800px at 15% -10%, #1a2c28 0%, transparent 55%),
                  radial-gradient(900px 700px at 90% 10%, #2b2018 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg-0), var(--bg-2));
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 32px auto 80px;
      padding: 0 24px;
      position: relative;
    }

    .hero {
      display: grid;
      gap: 10px;
      margin-bottom: 24px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(26px, 3vw, 36px);
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .hero .subtitle {
      color: var(--muted);
      font-size: 15px;
      line-height: 1.5;
      max-width: 880px;
    }

    .highlight {
      color: var(--text);
      background: linear-gradient(120deg, rgba(59, 169, 124, 0.25), rgba(59, 169, 124, 0));
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(59, 169, 124, 0.35);
      font-weight: 600;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-lg);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .panel + .panel {
      margin-top: 18px;
    }

    .panel-controls {
      display: grid;
      gap: 16px;
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .field label {
      display: block;
      font-size: 13px;
      color: var(--muted-2);
      margin-bottom: 8px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    input[type="file"],
    select,
    input[type="search"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--panel-strong);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="file"]::file-selector-button {
      background: #eff4f8;
      color: #1b2632;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      margin-right: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    input[type="file"]::-webkit-file-upload-button {
      background: #eff4f8;
      color: #1b2632;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      margin-right: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    input[type="file"]:focus,
    select:focus,
    input[type="search"]:focus {
      border-color: rgba(59, 169, 124, 0.7);
      box-shadow: 0 0 0 2px rgba(59, 169, 124, 0.25);
    }

    .btn {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease;
    }

    .btn:hover { transform: translateY(-1px); }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .panel-meta {
      display: grid;
      gap: 12px;
      margin-top: 6px;
    }

    .meta-text {
      color: var(--muted);
      font-size: 14px;
    }

    .chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(9, 13, 18, 0.6);
      border: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
    }

    .chip-green { border-color: rgba(59, 211, 122, 0.45); }
    .chip-orange { border-color: rgba(242, 163, 58, 0.45); }
    .chip-red { border-color: rgba(244, 90, 90, 0.45); }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .dot.green { background: var(--green); }
    .dot.orange { background: var(--orange); }
    .dot.red { background: var(--red); }

    .total {
      margin-left: auto;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(9, 13, 18, 0.6);
      font-size: 13px;
      color: var(--muted);
      width: fit-content;
    }

    .panel-note {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(8, 12, 18, 0.6);
    }

    .results-panel {
      padding: 16px 18px 18px;
    }

    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .results-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .legend {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .empty {
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(7, 10, 14, 0.7);
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 10px;
    }

    .results {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }

    .table-head,
    .result-row {
      display: grid;
      grid-template-columns: 150px 140px 120px 120px 120px 1fr;
      gap: 12px;
      align-items: center;
    }

    .table-head {
      font-size: 12px;
      color: var(--muted-2);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      padding: 8px 12px;
    }

    .result-row {
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(8, 12, 18, 0.75);
    }

    .cell {
      font-size: 14px;
      color: var(--text);
    }

    .cell.mono {
      font-family: "IBM Plex Mono", "Courier New", monospace;
      letter-spacing: 0.2px;
      font-size: 13px;
    }

    .status-cell {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .status-green { color: var(--green); }
    .status-orange { color: var(--orange); }
    .status-red { color: var(--red); }

    .hidden { display: none; }


    .fade-in {
      animation: fadeIn 0.6s ease both;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 900px) {
      .table-head,
      .result-row {
        grid-template-columns: 1fr 1fr;
        row-gap: 6px;
      }

      .table-head { display: none; }

      .result-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .results-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .total { margin-left: 0; }
    }
  </style>
</head>
<body>
  <main class="page fade-in">
    <header class="hero">
      <h1>Leerlingoverzicht - filter op <span class="highlight">Klas</span> en <span class="highlight">Mentor</span></h1>
      <p class="subtitle">
        Upload het Excel-bestand met leerlingregels. Kies daarna eerst een leerjaar, en vervolgens een klas en/of mentor,
        om per leerlingnummer een status te zien (<span style="color: var(--green);">bevorderd</span> /
        <span style="color: var(--orange);">besproken</span> /
        <span style="color: var(--red);">niet bevorderd</span>).
      </p>
    </header>

    <section class="panel panel-controls">
      <div class="panel-grid">
        <div class="field">
          <label for="fileInput">1) Upload leerlingbestand (.xlsx)</label>
          <input id="fileInput" type="file" accept=".xlsx" />
        </div>
        <div class="field">
          <label for="yearSelect">2) Kies leerjaar</label>
          <select id="yearSelect" disabled>
            <option value="">Eerst uploaden</option>
          </select>
        </div>
        <div class="field">
          <label for="classSelect">3) Kies klas</label>
          <select id="classSelect" disabled>
            <option value="">Eerst leerjaar kiezen</option>
          </select>
        </div>
        <div class="field">
          <label for="mentorSelect">4) Kies mentor</label>
          <select id="mentorSelect" disabled>
            <option value="">Eerst leerjaar kiezen</option>
          </select>
        </div>
        <div class="field">
          <label for="searchInput">5) Zoek leerlingnummer (optioneel)</label>
          <input id="searchInput" type="search" placeholder="bijv. 75865" disabled />
        </div>
        <div class="field">
          <label for="downloadBtn">6) Download CSV (optioneel)</label>
          <button class="btn" type="button" id="downloadBtn" disabled>Download CSV</button>
        </div>
      </div>

      <div class="panel-meta">
        <div id="fileInfo" class="meta-text">Nog geen bestand geüpload.</div>
        <div class="chips">
          <div class="chip chip-green"><span class="dot green"></span><span id="statGreen">0</span> bevorderd</div>
          <div class="chip chip-orange"><span class="dot orange"></span><span id="statOrange">0</span> besproken</div>
          <div class="chip chip-red"><span class="dot red"></span><span id="statRed">0</span> niet bevorderd</div>
          <div class="total" id="totalShown">Totaal getoond: 0</div>
        </div>
        <div class="panel-note">
          Interpretatie: dit dashboard rekent met hele cijfers. Waarden met decimalen worden afgerond.
          Zonder profielinformatie wordt alles conservatief als <strong>besproken</strong> weergegeven.
        </div>
      </div>
    </section>

    <section class="panel results-panel">
      <div class="results-header">
        <h2>Resultaten</h2>
        <div class="legend">
          <span><span class="dot green"></span>bevorderd</span>
          <span><span class="dot orange"></span>besproken</span>
          <span><span class="dot red"></span>niet bevorderd</span>
        </div>
      </div>

      <div id="message" class="empty">Nog geen bestand geüpload.</div>
      <div class="table-head">
        <div>Status</div>
        <div>Leerlingnummer</div>
        <div>Leerjaar</div>
        <div>Klas</div>
        <div>Mentor</div>
        <div>Toelichting (compact)</div>
      </div>
      <ul id="results" class="results"></ul>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // === Configuratie (aanpasbaar) ===
    const STUDENT_ID_FIELDS = ['Leerlingnaam', 'Leerlingnummer'];
    const IGNORE_COLUMNS = ['Studie', 'Klas', 'Mentor', 'Leerlingnaam', 'Leerlingnummer', 'Vak'];
    const MAATSCHAPPIJLEER_COL = 'MAAT';
    const ANW_COL = 'ANW';
    const LO_COL = 'LO';

    const fileInput = document.getElementById('fileInput');
    const yearSelect = document.getElementById('yearSelect');
    const classSelect = document.getElementById('classSelect');
    const mentorSelect = document.getElementById('mentorSelect');
    const resultsEl = document.getElementById('results');
    const messageEl = document.getElementById('message');
    const fileInfoEl = document.getElementById('fileInfo');
    const statGreenEl = document.getElementById('statGreen');
    const statOrangeEl = document.getElementById('statOrange');
    const statRedEl = document.getElementById('statRed');
    const totalShownEl = document.getElementById('totalShown');
    const searchInput = document.getElementById('searchInput');
    const downloadBtn = document.getElementById('downloadBtn');

    let students = [];
    let lastFiltered = [];

    function normalizeValue(value) {
      if (value === null || value === undefined) return null;
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (trimmed === '' || trimmed === '-') return null;
        const num = Number(trimmed.replace(',', '.'));
        if (!Number.isNaN(num)) return Math.round(num);
        if (trimmed.toUpperCase() === 'O') return 5;
        return 6;
      }
      if (typeof value === 'number') return Math.round(value);
      return null;
    }

    function getStudentId(row) {
      for (const field of STUDENT_ID_FIELDS) {
        if (row[field] !== undefined && row[field] !== null && String(row[field]).trim() !== '') {
          return String(row[field]).trim();
        }
      }
      return null;
    }

    function buildStudents(rows) {
      students = [];
      for (const row of rows) {
        const leerlingId = getStudentId(row);
        if (!leerlingId) continue;

        const studie = row.Studie ? String(row.Studie).trim() : '';
        const klas = row.Klas ? String(row.Klas).trim() : '';
        const mentor = row.Mentor ? String(row.Mentor).trim() : '';

        const grades = [];
        const letterGrades = {};

        for (const [key, value] of Object.entries(row)) {
          if (IGNORE_COLUMNS.includes(key)) continue;
          const norm = normalizeValue(value);
          if (norm === null) continue;
          grades.push({ subject: key, value: norm });

          if (typeof value === 'string') {
            letterGrades[key] = value.trim();
          }
        }

        students.push({ studie, klas, mentor, leerlingId, grades, letterGrades });
      }
    }

    function fillSelect(select, values, placeholder) {
      select.innerHTML = '';
      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = placeholder;
      select.appendChild(allOption);

      for (const v of values) {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      }
      select.disabled = false;
    }

    function countGrades(grades) {
      let c4 = 0;
      let c5 = 0;
      let below4 = 0;
      let allGE6 = true;
      for (const g of grades) {
        if (g.value < 4) below4++;
        if (g.value === 4) c4++;
        if (g.value === 5) c5++;
        if (g.value < 6) allGE6 = false;
      }
      return { c4, c5, below4, allGE6 };
    }

    function compactNote(grades) {
      const { c4, c5, below4, allGE6 } = countGrades(grades);
      if (allGE6) return 'alles >= 6';
      const parts = [];
      if (c5) parts.push(`${c5}x5`);
      if (c4) parts.push(`${c4}x4`);
      if (below4) parts.push(`${below4}x<4`);
      return parts.length ? parts.join(' / ') : '-';
    }

    function statusG1(grades) {
      const { c5, c4, below4, allGE6 } = countGrades(grades);
      if (allGE6) return 'green';
      if (c4 === 0 && c5 <= 2 && below4 === 0) return 'green';
      return 'orange';
    }

    function statusG2orG3(grades) {
      const { c5, c4, below4, allGE6 } = countGrades(grades);
      if (allGE6) return 'green';
      if (below4 === 0 && ((c5 === 1 && c4 === 0) || (c4 === 1 && c5 === 0) || (c5 === 2 && c4 === 0))) {
        return 'green';
      }
      const orangeConditions = [
        (c5 === 3 && c4 === 0),
        (c4 === 1 && c5 === 1),
        (c4 === 2 && c5 === 0),
        (c4 === 1 && c5 === 2),
        (c5 === 4 && c4 === 0)
      ];
      if (below4 === 0 && orangeConditions.some(Boolean)) return 'orange';
      return 'red';
    }

    function statusG4(grades) {
      const { c5, c4, below4, allGE6 } = countGrades(grades);
      if (allGE6) return 'green';
      if (below4 === 0 && ((c5 === 1 && c4 === 0) || (c4 === 1 && c5 === 0))) return 'green';
      const orangeConditions = [
        (c5 === 2 && c4 === 0),
        (c5 === 3 && c4 === 0),
        (c4 === 1 && c5 === 1),
        (c4 === 2 && c5 === 0),
        (c4 === 1 && c5 === 2)
      ];
      if (below4 === 0 && orangeConditions.some(Boolean)) return 'orange';
      return 'red';
    }

    function statusG5(student) {
      let grades = [...student.grades];

      const anw = grades.find(g => g.subject === ANW_COL);
      const maat = grades.find(g => g.subject === MAATSCHAPPIJLEER_COL);
      if (anw && maat) {
        const avg = Math.round((anw.value + maat.value) / 2);
        grades = grades.filter(g => g.subject !== ANW_COL && g.subject !== MAATSCHAPPIJLEER_COL);
        grades.push({ subject: 'ANW+MAAT', value: avg });
      }

      const { c5, c4, below4, allGE6 } = countGrades(grades);
      if (below4 > 0) return 'red';

      let comp = 0;
      for (const g of grades) {
        if (g.value >= 7) comp += (g.value - 6);
      }

      const loLetter = student.letterGrades[LO_COL];
      if (loLetter) {
        const l = loLetter.trim().toLowerCase();
        if (l === 'g' || l === 'zg' || l === 'tp') comp += 1;
      }

      if (allGE6) return 'green';

      const greenCombos = [
        { c4: 0, c5: 1, comp: 1 },
        { c4: 1, c5: 0, comp: 2 },
        { c4: 0, c5: 2, comp: 2 },
        { c4: 1, c5: 1, comp: 3 }
      ];

      for (const combo of greenCombos) {
        if (c4 === combo.c4 && c5 === combo.c5 && comp >= combo.comp) return 'green';
      }

      for (const combo of greenCombos) {
        if (c4 === combo.c4 && c5 === combo.c5 && comp === combo.comp - 1) return 'orange';
      }

      for (const combo of greenCombos) {
        if (c4 === combo.c4 && c5 === combo.c5 + 1 && comp >= combo.comp) return 'orange';
      }

      return 'red';
    }

    function determineStatus(student) {
      const studie = (student.studie || '').toUpperCase();
      if (studie.startsWith('G1')) return statusG1(student.grades);
      if (studie.startsWith('G2')) return statusG2orG3(student.grades);
      if (studie.startsWith('G3')) return statusG2orG3(student.grades);
      if (studie.startsWith('G4')) return statusG4(student.grades);
      if (studie.startsWith('G5')) return statusG5(student);
      return 'orange';
    }

    function updateStats({ green = 0, orange = 0, red = 0, total = 0 } = {}) {
      statGreenEl.textContent = green;
      statOrangeEl.textContent = orange;
      statRedEl.textContent = red;
      totalShownEl.textContent = `Totaal getoond: ${total}`;
    }

    function escapeCsv(value) {
      const text = value === null || value === undefined ? '' : String(value);
      if (/[\";\\n]/.test(text)) {
        return `\"${text.replace(/\"/g, '\"\"')}\"`;
      }
      return text;
    }

    function buildCsv(rows) {
      const header = ['Status', 'Leerlingnummer', 'Leerjaar', 'Klas', 'Mentor', 'Toelichting'];
      const lines = [header.join(';')];
      for (const student of rows) {
        const status = determineStatus(student);
        const statusText = status === 'green' ? 'Bevorderd' : status === 'orange' ? 'Besproken' : 'Niet bevorderd';
        const klasValue = student.studie && student.klas ? `${student.studie}${student.klas}` : (student.klas || '');
        const row = [
          statusText,
          student.leerlingId,
          student.studie || '',
          klasValue,
          student.mentor || '',
          compactNote(student.grades)
        ];
        lines.push(row.map(escapeCsv).join(';'));
      }
      return lines.join('\\n');
    }

    function downloadCsv() {
      if (!lastFiltered.length) return;
      const csv = buildCsv(lastFiltered);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'overgangsresultaten.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function createCell(text, className) {
      const cell = document.createElement('div');
      cell.className = className ? `cell ${className}` : 'cell';
      cell.textContent = text;
      return cell;
    }

    function render() {
      resultsEl.innerHTML = '';
      lastFiltered = [];
      downloadBtn.disabled = true;

      if (!students.length) {
        messageEl.textContent = 'Nog geen bestand geüpload.';
        messageEl.style.display = 'block';
        updateStats();
        return;
      }

      const yearFilter = yearSelect.value;
      const classFilter = classSelect.value;
      const mentorFilter = mentorSelect.value;
      const query = searchInput.value.trim();

      let filtered = students;
      if (!yearFilter) {
        messageEl.textContent = 'Kies eerst een leerjaar.';
        messageEl.style.display = 'block';
        updateStats();
        return;
      }

      filtered = filtered.filter(s => s.studie === yearFilter);

      if (classFilter) {
        filtered = filtered.filter(s => `${s.studie}${s.klas}` === classFilter);
      }
      if (mentorFilter) {
        filtered = filtered.filter(s => s.mentor === mentorFilter);
      }

      if (query) {
        filtered = filtered.filter(s => String(s.leerlingId).includes(query));
      }

      if (filtered.length === 0) {
        messageEl.textContent = 'Geen resultaten voor deze selectie.';
        messageEl.style.display = 'block';
        updateStats();
        return;
      }

      lastFiltered = filtered;
      downloadBtn.disabled = false;
      messageEl.style.display = 'none';

      const counts = { green: 0, orange: 0, red: 0 };

      for (const student of filtered) {
        const status = determineStatus(student);
        counts[status]++;

        const row = document.createElement('li');
        row.className = 'result-row';

        const statusCell = document.createElement('div');
        statusCell.className = `cell status-cell status-${status}`;
        const dot = document.createElement('span');
        dot.className = `dot ${status}`;
        const statusText = document.createElement('span');
        statusText.textContent = status === 'green' ? 'Bevorderd' : status === 'orange' ? 'Besproken' : 'Niet bevorderd';
        statusCell.appendChild(dot);
        statusCell.appendChild(statusText);

        const klasValue = student.studie && student.klas ? `${student.studie}${student.klas}` : (student.klas || '-');

        row.appendChild(statusCell);
        row.appendChild(createCell(student.leerlingId, 'mono'));
        row.appendChild(createCell(student.studie || '-', ''));
        row.appendChild(createCell(klasValue, ''));
        row.appendChild(createCell(student.mentor || '-', ''));
        row.appendChild(createCell(compactNote(student.grades), 'mono'));

        resultsEl.appendChild(row);
      }

      updateStats({
        green: counts.green,
        orange: counts.orange,
        red: counts.red,
        total: filtered.length
      });
    }

    function setSelectPlaceholder(select, text) {
      select.innerHTML = '';
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = text;
      select.appendChild(opt);
      select.disabled = true;
    }

    function populateFiltersForYear(year) {
      if (!year) {
        setSelectPlaceholder(classSelect, 'Eerst leerjaar kiezen');
        setSelectPlaceholder(mentorSelect, 'Eerst leerjaar kiezen');
        return;
      }

      const classSet = new Set();
      const mentorSet = new Set();
      for (const s of students) {
        if (s.studie !== year) continue;
        if (s.studie && s.klas) classSet.add(`${s.studie}${s.klas}`);
        if (s.mentor) mentorSet.add(s.mentor);
      }

      fillSelect(classSelect, Array.from(classSet).sort(), 'Alle klassen');
      fillSelect(mentorSelect, Array.from(mentorSet).sort(), 'Alle mentoren');
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const raw = XLSX.utils.sheet_to_json(sheet, { defval: null });

        buildStudents(raw);

        const yearSet = new Set();
        for (const s of students) {
          if (s.studie) yearSet.add(s.studie);
        }
        fillSelect(yearSelect, Array.from(yearSet).sort(), 'Kies leerjaar');
        setSelectPlaceholder(classSelect, 'Eerst leerjaar kiezen');
        setSelectPlaceholder(mentorSelect, 'Eerst leerjaar kiezen');
        messageEl.textContent = 'Kies eerst een leerjaar.';
        messageEl.style.display = 'block';

        fileInfoEl.textContent = `Bestand geladen: ${file.name} - rijen: ${raw.length} - leerlingen: ${students.length}`;
        searchInput.disabled = false;
        render();
      };
      reader.readAsArrayBuffer(file);
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      handleFile(file);
    });

    yearSelect.addEventListener('change', () => {
      populateFiltersForYear(yearSelect.value);
      render();
    });
    classSelect.addEventListener('change', render);
    mentorSelect.addEventListener('change', render);
    searchInput.addEventListener('input', render);
    downloadBtn.addEventListener('click', downloadCsv);
  </script>
</body>
</html>
